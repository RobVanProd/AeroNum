name: Package Ecosystem Deployment (Docs + Playground)
on:
  push:
    branches:
      - main

jobs:
  deploy_hub:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Branch
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Aero Compiler from upstream
        run: |
          git clone https://github.com/RobVanProd/Aero.git /tmp/aero
          cd /tmp/aero/src/compiler
          cargo build --release
          echo "/tmp/aero/src/compiler/target/release" >> $GITHUB_PATH

      - name: Build Static-Site Generator
        run: |
          # Build docs (graceful fallback if aero binary not yet bootstrapped)
          if command -v aero &> /dev/null; then
            aero run --bin docs --manifest-path docs/aero.toml || echo "Docs build skipped during bootstrap"
          else
            echo "Aero compiler not in PATH, skipping docs generation"
            mkdir -p docs/public
            cp -r docs/*.md docs/public/ 2>/dev/null || true
          fi

      - name: Compile Interactive WebAssembly payloads
        continue-on-error: true
        run: |
          if command -v aero &> /dev/null; then
            aero build --target wasm32-wasi --manifest-path playground/aero.toml || echo "WASM build skipped"
            cp target/wasm32-wasi/release/playground.wasm playground/public/ 2>/dev/null || true
          else
            echo "Skipping WASM compilation â€” aero not available"
          fi

      - name: Deploy Docs & Playground to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs/public
